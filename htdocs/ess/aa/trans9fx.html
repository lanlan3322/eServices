<!--
trans9fx.html - split receipt with FX
Copyright (C) 2004 R. James Holton

This program is free software; you can redistribute it and/or modify it 
under the terms of the GNU General Public License as published by the 
Free Software Foundation; either version 2 of the License, or (at your option) 
any later version.  This program is distributed in the hope that it will be 
useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General 
Public License for more details.

You should have received a copy of the GNU General Public License along with 
this program; if not, write to the Free Software Foundation, Inc., 
675 Mass Ave, Cambridge, MA 02139, USA. 
-->
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Split Receipt with FX</title>
<link rel="stylesheet" href="../expense.css" type="text/css"></head>

<body onLoad="javascript: void FillForm()">

<form method="POST" action="javascript: void SubmitRec()">
  <input type="hidden" name="ratetype" value>
  <input type="hidden" name="xsource" value>
  <input type="hidden" name="xrate" value>
  <input type="hidden" name="xdate" value>
  <input type="hidden" name="expense_1_persplit" value>
  <input type="hidden" name="expense_2_persplit" value>
  <input type="hidden" name="expense_3_persplit" value>
  <table border="0" width="100%" cellpadding="0" cellspacing="0" class="offsetColor">
    <tr>
      <td width="50%"><big><big><big><em><strong>Split Receipt</strong></em></big></big></big></td>
    </tr>
  </table>
  <p><br>
  </p>
<table border="0" width="100%" cellpadding="0" cellspacing="0">
    <tr>
      <td width="20%" class="offsetColor"><div class="ExpenseTag">Receipt Date:</div></td>
      <td width="20%" class="offsetColor"><input type="text" name="rcptdate" size="13" tabindex="1"><a HREF="javascript:doNothing()" tabindex="2" onClick="setDateField(document.forms[0].rcptdate);"><img SRC="../calendar.gif" BORDER="0" WIDTH="16" HEIGHT="16"></a></td>
      <td width="15%" class="offsetColor"><div class="ExpenseTag">Currency:</div></td>
      <td width="45%" class="offsetColor"><input type="text" name="units" size="16" readOnly="yes"><em><strong><small><font face="Arial" size="1"><a href="javascript:doNothing()" tabindex="3" onClick="setFgnLocalVars(document.forms[0].recamt,document.forms[0].amount);top.newWin = window.open('../fx1.html', 'fx', 'dependent=yes, width=520, height=360, screenX=580, screenY=420, titlebar=yes, status=yes')">
      Select Currency</a></div></td>
    </tr>
    <tr>
      <td width="20%"><div class="ExpenseTag"><script>document.write(parent.contents.getCurrencyLabel())</script>:</div></td>
      <td width="20%"><input type="text" name="amount" size="12" value tabindex="4" onChange="CheckAmount(this.form.amount)"></td>
      <td width="15%"><div class="ExpenseTag">Foreign Amount:</div></td>
      <td width="45%"><input type="text" name="recamt" size="9" value tabindex="5" onChange="FXConvert();swFgnProtect()" readOnly="yes"></td>
    </tr>
</table>
  <table border="0" width="100%" cellpadding="0" cellspacing="0">
    <tr>
      <td width="20%" class="offsetColor"><div class="ExpenseTag">Payment Method:</div></td>
      <td width="80%" class="offsetColor"><select name="charge" size="1" tabindex="6">
      </select></td>
    </tr>
    <tr>
      <td width="20%"><div class="ExpenseTag">Reference</div></td>
      <td width="80%"><input type="text" name="refer" size="20" tabindex="7"></td>
    </tr>
    <tr>
      <td width="20%" class="offsetColor"><div class="ExpenseTag">Purpose:</div> </td>
      <td width="80%" class="offsetColor"><select name="purpose" size="1" xref="xref" tabindex="8">
      </select><!-- purpose and xref are expense items and must be populated --></td>
    </tr>
    <tr>
      <td width="20%"><div class="ExpenseTag"># of persons</div></td>
      <td width="80%"><input type="text" name="persplit" size="5" tabindex="9"></td>
    </tr>
  </table>
  <table border="0" width="100%" cellpadding="0">
        <tr class="offsetColor">
          <td width="108"><div class="ExpenseTag">Expense Type</div></td>
          <td width="82"><div class="ExpenseTag"><script>document.write(parent.contents.getCurrencyLabel())</script></div></td>
          <td width="82"><div class="ExpenseTag">Foreign Amount</div></td>
          <td width="125"><div class="ExpenseTag">Department</div></td>
          <td width="341"><div class="ExpenseTag">Comment</div></td>
        </tr>
        <tr>
          <td width="108"><select name="expense_1_expensetype" size="1" tabindex="100">
          </select></td>
          <td width="92"><input type="text" name="expense_1_amount" size="9" tabindex="101" subtype="nonzero" onChange="CheckAmount(this.form.expense_1_amount)"></td>
          <td width="92"><input type="text" name="expense_1_recamt" readonly="yes" size="9" tabindex="102" subtype="nonzero" onChange="FXConvert('expense_1_recamt', 'expense_1_amount')"></td>
          <td width="138"><select name="expense_1_depart" size="1" tabindex="103">
          </select></td>
          <td width="372"><input type="text" name="expense_1_comment" tabindex="104" size="36" onChange="CheckComment(this.form.expense_1_comment)"></td>
        </tr>
        <tr class="offsetColor">
          <td width="108"><select name="expense_2_expensetype" size="1" tabindex="200">
          </select></td>
          <td width="92"><input type="text" name="expense_2_amount" size="9" subtype="nonzero" tabindex="201" onChange="CheckAmount(this.form.expense_2_amount)"></td>
          <td width="92"><input type="text" name="expense_2_recamt" readonly="yes" size="9" subtype="nonzero" tabindex="203" onChange="FXConvert('expense_2_recamt', 'expense_2_amount')"></td>
          <td width="138"><select name="expense_2_depart" tabindex="204" size="1">
          </select></td>
          <td width="372"><input type="text" name="expense_2_comment" tabindex="205" size="36" onChange="CheckComment(this.form.expense_2_comment)"></td>
        </tr>
        <tr>
          <td width="109"><select name="expense_3_expensetype" size="1" tabindex="300">
          </select></td>
          <td width="91"><input type="text" name="expense_3_amount" size="9" subtype="nonzero" tabindex="301" onChange="CheckAmount(this.form.expense_3_amount)"></td>
          <td width="91"><input type="text" name="expense_3_recamt" readonly="yes" size="9" subtype="nonzero" tabindex="302" onChange="FXConvert('expense_3_recamt', 'expense_3_amount')"></td>
          <td width="138"><select name="expense_3_depart" tabindex="303" size="1">
          </select></td>
          <td width="372"><input type="text" name="expense_3_comment" tabindex="304" size="36" onChange="CheckComment(this.form.expense_3_comment)"></td>
        </tr>
  </table>
  <p><input type="button" value="Update report with this receipt" name="Submit" tabindex="900" onClick="Javascript: void SubmitRec()" onDblClick="parent.contents.dupFlagOK = false"></p>
</form>

<p align="right"><a href="javascript: void parent.contents.ListDelay()" tabindex="901"><em><strong>Return
to receipt display</strong></em></a></p>
</body>
<script LANGUAGE="JavaScript" SRC="../calendar.js"></script>
<script LANGUAGE="JavaScript" SRC="../attendee.js"></script>
<script LANGUAGE="JavaScript" SRC="../addmerchant.js"></script>
<script LANGUAGE="JavaScript" SRC="../fx1.js"></script>
<script LANGUAGE="JavaScript">

function SubmitRec() {

  if (document.forms[0].charge.selectedIndex < 1) {
    alert("Must have a valid payment method");
    return;
  }


  with (document.forms[0]) {

   expense_1_amount.subtype = "nonzero";  //needed for Mozilla
   expense_2_amount.subtype = "nonzero";
   expense_3_amount.subtype = "nonzero";
   expense_1_recamt.subtype = "nonzero";
   expense_2_recamt.subtype = "nonzero";
   expense_3_recamt.subtype = "nonzero";

   ChkExtra2(expense_1_expensetype,expense_1_amount);
   ChkExtra2(expense_2_expensetype,expense_2_amount);
   ChkExtra2(expense_3_expensetype,expense_3_amount);
  
   if (CheckAmount(amount)
      && checkdate(rcptdate) 
      && doDateChkToday(rcptdate)
      && CheckComment(expense_1_comment, expense_1_expensetype.options[expense_1_expensetype.selectedIndex].text)
      && CheckTotals() && ChkFgnBalance()) {
    if (!isNaN(amount.value)) parent.contents.makeCurrency(amount);

    if (ChkExtra1(expense_1_amount,expense_1_expensetype,expense_1_depart,expense_1_comment,expense_1_persplit)) parent.contents.makeCurrency(expense_1_amount);
    if (ChkExtra1(expense_2_amount,expense_2_expensetype,expense_2_depart,expense_2_comment,expense_2_persplit)) parent.contents.makeCurrency(expense_2_amount);
    if (ChkExtra1(expense_3_amount,expense_3_expensetype,expense_3_depart,expense_3_comment,expense_3_persplit)) parent.contents.makeCurrency(expense_3_amount);
    
    parent.contents.UpdateReport('2','trans9fx');
    parent.contents.ListDelay();
  } else
    alert("Pls chk receipt - invalid data");
  }
}
function fxCleanUp() {
        checkCurrency('recamt','amount');
        checkCurrency('expense_1_recamt','expense_1_amount');
        checkCurrency('expense_2_recamt','expense_2_amount');
        checkCurrency('expense_3_recamt','expense_3_amount');
}

function checkCurrency(x,y){
        var z = isEmpty(document.forms[0].xrate.value)
        setFgnProtected(z, x, y);
        FXConvert(x, y);
}

function CheckTotals(formObj) {
   formObj = document.forms[0];
           var Amt = ChkTotal1(formObj.amount.value);
           var exp1Amt = ChkTotal1(formObj.expense_1_amount.value);
           var exp2Amt = ChkTotal1(formObj.expense_2_amount.value);
           var exp3Amt = ChkTotal1(formObj.expense_3_amount.value);
           var expAmt = exp1Amt + exp2Amt + exp3Amt;
           if (Amt - expAmt < 0.005 && expAmt - Amt < 0.005) {
                   return true;
           } else {
                   alert("Receipt is out of balance by " + (Amt - (exp1Amt + exp2Amt + exp3Amt)));
                   return false;
           }
           var rec = ChkTotal1(formObj.recamt.value);
           var rec1Amt = ChkTotal1(formObj.expense_1_recamt.value);
           var rec2Amt = ChkTotal1(formObj.expense_2_recamt.value);
           var rec3Amt = ChkTotal1(formObj.expense_3_recamt.value);
           var recAmt = exp1Amt + exp2Amt + exp3Amt;
           if (Amt - recAmt < 0.005 && recAmt - rec < 0.005) {
                   return true;
           } else {
                   alert("Receipt is out of balance by " + (rec - (rec1Amt + rec2Amt + rec3Amt)));
                   return false;
           }
}

function ChkTotal1(v1) {
  if (isNaN(v1) || v1 == "") {
    return 0;
  }else{
    return Number(v1);
  }
}

function ChkExtra1(o1,o2,o3,o4,o5) {
  if (o1.value == "" || isNaN(o1.value) || o1 == 0) {
    o1.value = "";
    o2.selectedIndex = 0;
    o3.selectedIndex = 0;
    o4.value = "";
    o5.value = "";
    return false;
  } else {
    o5.value = document.forms[0].persplit.value;
    return true;
  }
}

function ChkExtra2(o1,o2) {
  if (o1.selectedIndex == 0) {
    o2.value = "";
  }
}

function ChkFgnBalance(x) {
  var flag = true;
  if (document.forms[0].xrate.value != "") {
    if (chkf1(document.forms[0].expense_1_recamt.value, document.forms[0].expense_1_amount.value)) flag = false;
    if (chkf1(document.forms[0].expense_2_recamt.value, document.forms[0].expense_2_amount.value)) flag = false;
    if (chkf1(document.forms[0].expense_3_recamt.value, document.forms[0].expense_3_amount.value)) flag = false;
  } 
  if (!flag) {
    alert("Cannot mix foreign and non-foreign transactions on this form");
  }
  return flag;
}

function chkf1(x,y) {
  if (x == "" && y != "") {
    return true;
  } else {
    return false;
  }
}

function CheckAmount(tag) {
  return parent.contents.checkAmtFldOK(tag);
}

var NeedComment = parent.contents.getCommentReq();
function CheckComment(tag,expensetype) {
  var Check = parent.contents.alltrim(tag.value);
  if (NeedComment.indexOf(";" + expensetype + ";") > -1 && Check.length < 10) {
     alert("Need to supply a comment of at least 10 characters");
     tag.focus();
     tag.select();
     return false;
  } else {
     return true;
  }
}

function FillForm() {
  if (parent.contents.HeadList.length > 0) {
    //Gets a simple list found in personal.js
    parent.contents.setList(document.forms[0].expense_1_expensetype, parent.contents.getExpenseTypes(parent.Category));
    parent.contents.setList(document.forms[0].expense_2_expensetype, parent.contents.getExpenseTypes(parent.Category));
    parent.contents.setList(document.forms[0].expense_3_expensetype, parent.contents.getExpenseTypes(parent.Category));
    FillDepartsEtAl();
    document.forms[0].rcptdate.focus();
  } else {
    alert("You must specify a purpose first, then choose Split Receipt again.");
    parent.contents.TransWindow(parent.contents.defaultHead + parent.contents.getPurposeHTML());
  }
}

function FillDepartsEtAl() {
    departList = parent.contents.getDeparts("1");
    parent.contents.setList(document.forms[0].expense_1_depart, departList);
    parent.contents.setList(document.forms[0].expense_2_depart, departList);
    parent.contents.setList(document.forms[0].expense_3_depart, departList);

    //Sets the payment types list
    parent.contents.setList(document.forms[0].charge, parent.contents.getPaymentTypes("1"));
    parent.contents.setListDefault(document.forms[0].charge, parent.contents.getChargeDef());
    //Sets the purpose pulldown from the HeadList
    parent.contents.setDefaultFromHead(document.forms[0].purpose);
    //Sets the default dates
    document.forms[0].rcptdate.value = getPurpDate(parent.defPurpose);
    document.forms[0].persplit.value = "1";
    //Brings in any transaction information (note date above can be optimized against this later)
    parent.contents.setTransaction(document.forms[0]);
    fxCleanUp();
}

function swFgnProtect() {
    setFgnProtected(false, 'expense_1_recamt', 'expense_1_amount');
    setFgnProtected(false, 'expense_2_recamt', 'expense_2_amount');
    setFgnProtected(false, 'expense_3_recamt', 'expense_3_amount');
}


</script>

</html>
